# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0

FROM public.ecr.aws/amazonlinux/amazonlinux:2 AS base
WORKDIR /source
# Install .NET 6 and other dependencies for compiling naively
RUN yum update -y 
RUN yum install -y clang krb5-devel openssl-devel libicu wget zip tar gzip
RUN mkdir -p /tmp/dotnet
RUN wget https://download.visualstudio.microsoft.com/download/pr/9762c43b-6de2-44aa-928d-61bec028a330/ba4d124e5384ae5c5a4599afbc41b1bf/dotnet-sdk-7.0.100-preview.6.22352.1-linux-x64.tar.gz
RUN tar zxf dotnet-sdk-7.0.100-preview.6.22352.1-linux-x64.tar.gz -C /tmp/dotnet
#RUN export DOTNET_ROOT=/tmp/dotnet
#RUN export PATH=$PATH:/tmp/dotnet

COPY . .
RUN /tmp/dotnet/dotnet publish -r linux-x64 -c Release --self-contained
RUN strip /source/bin/Release/net7.0/linux-x64/native/bootstrap
RUN cp /source/bin/Release/net7.0/linux-x64/native/bootstrap bootstrap
RUN zip package.zip bootstrap